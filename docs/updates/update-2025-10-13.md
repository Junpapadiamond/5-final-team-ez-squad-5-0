# Update — 2025-10-13

## Current Platform Snapshot
- Couples flow spans Auth, Daily Question, Quiz, Messages, and Calendar sharing Mongo collections (`docs/overview/README.md:3`).
- Auth issues JWTs, manages partner invitations, and notification preferences (`docs/auth/README.md:3`).
- Messages handles real-time and scheduled partner notes with UTC normalization and email alerts (`docs/messages/README.md:3`).
- Daily Question provides deterministic prompts and answer storage for both partners (`docs/daily-question/README.md:3`).
- Quiz runs synchronized compatibility sessions with scoring history in `quiz_sessions` (`docs/quiz/README.md:3`).
- Calendar keeps shared plans aligned with partner-aware queries and formatting (`docs/calendar/README.md:3`).

## Agent Architecture Today
- `AgentLLMClient` wraps OpenAI Responses/Chat APIs with JSON schemas and payload normalizers (`api-container/app/services/agent_llm_client.py:18`).
- `AgentOrchestrator` assembles partner, daily-question, message, event, and style data for each LLM call (`api-container/app/services/agent_orchestrator.py:18`).
- `AgentAnalysisService` hashes drafts, reuses cached tone results, and falls back to heuristics (`api-container/app/services/agent_analysis_service.py:35`).
- `AgentSuggestionService` merges OpenAI coaching cards with deterministic reminders and caches merged bundles (`api-container/app/services/agent_suggestion_service.py:17`).
- `StyleProfileService` builds linguistic fingerprints and optionally enriches them with LLM summaries (`api-container/app/services/style_profile_service.py:49`).
- Frontend agent page surfaces AI provenance, cache status, and sentiment badges (`frontend/src/app/agent/page.tsx:1`).

## Response-Speed Optimizations
- Limit Mongo lookups to the three most recent messages/events and project only needed fields before prompting (`api-container/app/services/agent_orchestrator.py:85`).
- Cache the assembled context per request so tone analysis and suggestion generation reuse the same data (`api-container/app/services/agent_suggestion_service.py:17`).
- Reduce style-profile sampling (e.g., ≤75 messages) to avoid scanning 200 documents every refresh cycle (`api-container/app/services/style_profile_service.py:53`).
- Lower default `AGENT_*_MAX_TOKENS` and trim prompt sections aggressively; env toggles already exist (`api-container/app/services/agent_llm_client.py:119`).
- Instrument token/latency logging and defer suggestion refreshes asynchronously so cached responses return instantly (`docs/agent/api-integration-v1.md:42`).

## Intelligence Enhancements
- Ship the RAG ingest pipeline plus `/api/insights/query` to ground coaching in historical answers and curated tips (`docs/agent/Agent_RAG_Implementation.md:50`).
- Implement workflow state machines for onboarding, daily nudges, quiz follow-ups, and anniversaries (`docs/agent/Agent_RAG_Implementation.md:75`).
- Collect user feedback on each suggestion to tune prompt weighting and acceptance scoring (`docs/agent/Agent_RAG_Implementation.md:102`).
- Feed style-profile traits directly into prompts for consistent voice mirroring (`docs/agent/Agent_RAG_Implementation.md:69`).
- Combine deterministic business checks with retrieved knowledge to boost action confidence (`api-container/app/services/agent_suggestion_service.py:52`).

## Voice Integration Outline
- Design opt-in, consent, and storage flows for voice capture before cloning (`docs/ideas.md:3`).
- Capture 30-second voice samples securely alongside existing messaging data (`docs/ideas.md:9`).
- Integrate compliant TTS (OpenAI Voice, ElevenLabs) guarded by feature flags and conditioned on style traits (`docs/ideas.md:10`).
- Reuse messaging/scheduling to draft, review, and queue voice notes just like text cards (`docs/ideas.md:30`).
- Add ASR (Whisper, Deepgram) for two-way voice loops feeding back into tone analysis (`docs/ideas.md:10`).

## Future Roadmap
- Deliver the Daily Engagement Copilot as the next agent milestone (`docs/ideas.md:15`).
- Explore timed creative messages and handwritten cards for differentiated touchpoints (`docs/ideas.md:30`).
- Investigate wellness logging with strict consent to expand empathetic context (`docs/ideas.md:21`).
- Plan partner-facing weekly summaries after RAG consent plumbing lands (`docs/agent/Agent_RAG_Implementation.md:97`).

## AI PM Positioning Highlights
- Storyline: heuristics → structured OpenAI outputs → RAG/voice roadmap with measurable responsiveness gains.
- Cross-functional ownership: backend services, Mongo schemas, React UI, deployment toggles under one initiative.
- Metrics-first narrative: cached analyses, latency wins, and explicit safeguards (fallbacks, consent flags).
- Rollout strategy: feature flags, cache-first UX, and async refresh to balance latency, cost, and reliability.

---

## Agentic Implementation Progress (Backend + Frontend)
- Added `agent_activity_worker.py` to continuously record new messages, quiz completions, daily-question misses, and calendar gaps while deduplicating entries in `agent_activity`.
- Introduced internal activity feed (`/api/internal/activity-feed`) and decision trigger (`/api/internal/decisions/run`) authenticated via `X-Internal-Token`.
- Built workflow engine (`AgentWorkflowEngine`) that converts activity events into structured action plans stored in `agent_action_queue` with state-machine handlers across onboarding, daily check-in, quiz follow-up, and anniversary planning.
- Created execution, audit, and feedback services to run approved actions (messages & calendar events), log results to `agent_audit`, and capture user sentiment in `agent_feedback`.
- Extended `/api/agent/actions` to return both LLM suggestions and automation queue entries, plus new endpoints for executing (`POST /api/agent/actions/<id>/execute`) and acknowledging feedback (`POST /api/agent/actions/<id>/feedback`).
- Updated the Next.js agent page to surface an Automation Queue with one-click execute/acknowledge actions alongside existing suggestions and tone analyzer.

## Testing & Validation Plan
- **Workers & Persistence**
  - Run `python workers/agent_activity_worker.py` against seeded data; confirm events populate `agent_activity`, dedupe keys prevent duplicates, and cursor docs advance.
  - Trigger `/api/internal/decisions/run` and verify `agent_action_queue` receives plans tied to corresponding events (`mongo shell` or Compass check).
- **API Surface**
  - `GET /api/internal/activity-feed` with valid `X-Internal-Token` → expect recent events.
  - `GET /api/agent/actions` with JWT → ensure response includes `suggestions` and `automation_queue` arrays.
  - `POST /api/agent/actions/<id>/execute` → confirm downstream side effect (message sent or calendar event created) and `agent_audit` entry.
  - `POST /api/agent/actions/<id>/feedback` → confirm queue status updates and new `agent_feedback` document.
- **Frontend UX**
  - Load agent console; confirm Automation Queue renders pending actions and buttons trigger backend routes.
  - Execute an action from UI and observe status refresh plus audit trail server-side.
  - Verify fallback messaging when queue is empty and error handling when execution fails.

## Suggested Next Steps
1. Stand up change-stream driven monitor (replace polling) once Mongo replica set is available to reduce latency.
2. Flesh out RAG endpoint, wiring `AgentWorkflowEngine._retrieve_insights` to real retrieval results.
3. Expand action-type coverage (e.g., automatic scheduled reminders) and enrich execution payload requirements on the frontend.
4. Add automated tests: unit tests for workflow handlers, integration tests covering execute/feedback flows, and Cypress checks for agent UI interactions.
