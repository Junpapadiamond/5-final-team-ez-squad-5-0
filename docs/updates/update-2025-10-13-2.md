# Update — 2025-10-13-2 (Agent Ops Monitor Follow-up)

## What Changed
- Added user-scoped telemetry endpoints so the Next.js app can read the agent pipeline without the internal service token:
  - `GET /api/agent/activity` returns the latest activity documents for the logged-in user with optional `limit`, `since`, and `include_processed` filters.
  - `GET /api/agent/queue` exposes pending and recently-completed automation queue items.
- Expanded the agent activity store/service to filter by `user_id`, preventing cross-user leakage when the frontend queries telemetry.
- Introduced the **Agent Operations Monitor** panel on the dashboard: a four-stage pipeline (Capture → Plan → Execute → Feedback) with live counts, stage progress bars, recent event details, and automation queue snapshots. The UI polls both new endpoints every 10 seconds.
- Renamed the global navigation tab to **Agent Ops** so the dashboard/agent pages share a clearer operations vocabulary.

## How To See Data Flow
1. **Make sure the ingestion worker is running.**  
   ```bash
   cd api-container
   python workers/agent_activity_worker.py
   ```
   This process records new messages, quiz updates, daily-question misses, and calendar gaps into `agent_activity`.

2. **Generate some signals.**  
   Send/receive a message, skip a daily question, or finish a quiz session. The worker will produce capture events that appear in the monitor’s “Capture” column.

3. **Kick the decision engine (unless you have a scheduler).**  
   The automation queue stays empty until `/api/internal/decisions/run` runs. Use the internal token with a JSON body:
   ```bash
   curl -X POST http://localhost:5001/api/internal/decisions/run \
     -H "X-Internal-Token: dev-internal-token" \
     -H "Content-Type: application/json" \
     -d '{}'
   ```
   Successful runs enqueue action plans, which move the “Plan” count in the monitor.

4. **Execute or acknowledge actions.**  
   `POST /api/agent/actions/<id>/execute` and `/feedback` (through the Agent page or manually) will push items through the Execute/Feedback stages. The monitor shows historical rows and relative timestamps.

## Why The Monitor Might Stay At Zero
- **No worker running.** Without `agent_activity_worker.py`, nothing records to `agent_activity`, so Capture remains empty.
- **Different database.** If the worker or API points to another Mongo instance (e.g., containers vs. local dev), the frontend user won’t see those events.
- **Decision engine not triggered.** The queue only fills when `/api/internal/decisions/run` executes. Call it manually or add a cron/job runner.
- **User mismatch.** Events are scoped per user; run actions as the same account you use in the browser, otherwise the telemetry endpoints filter your events out.
- **Auth header missing.** Internal endpoints require `X-Internal-Token` and JSON content. A 401 or 415 means the planner never ran.
- **Silent errors.** Check API logs for exceptions when recording events or enqueuing actions. If the monitor shows “Degraded,” open the browser console for the exact request failure.

## Next Follow-ups
- Automate planner execution (Celery beat, cron, or a lightweight async task) so the queue updates without manual cURL calls.
- Consider moving from polling to Mongo change streams or a websocket to reduce latency once the replica set is available.
- After telemetry is steady, resume the voice feature roadmap (ASR + TTS) described in `docs/ideas.md` and `docs/updates/update-2025-10-13.md`.
